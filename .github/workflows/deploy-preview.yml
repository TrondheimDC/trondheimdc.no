# Deploy Preview - Deploys new site to /secret_new_duck_site/ subfolder
# The old site continues to run at the root, untouched
name: Deploy Preview Site

on:
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      path_prefix:
        description: 'Subfolder path (e.g. secret_new_duck_site)'
        required: true
        default: 'secret_new_duck_site'

concurrency:
  group: "deploy-preview"
  cancel-in-progress: true

env:
  DEPLOY_ROOT: /var/www/sites/2026.trondheimdc.no/public

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: src
        run: bun install --frozen-lockfile

      - name: Build site with path prefix
        working-directory: src
        run: bun run build
        env:
          ELEVENTY_PATH_PREFIX: /${{ inputs.path_prefix }}/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-site
          path: src/_site/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: preview
      url: https://trondheimdc.no/${{ inputs.path_prefix }}/
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: preview-site
          path: src/_site/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to preview subfolder
        run: |
          # Only sync into the subfolder â€” the old site at the root is untouched
          rsync -rlvz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            src/_site/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_ROOT }}/${{ inputs.path_prefix }}/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  summary:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: Create job summary
        run: |
          echo "## Preview Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Path prefix:** \`/${{ inputs.path_prefix }}/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview URL:** https://trondheimdc.no/${{ inputs.path_prefix }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
